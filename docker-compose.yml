services:
  controller:
    build: .
    command: uvicorn controller:app --host 0.0.0.0 --port 8000
    ports:
      - "8000:8000"
    environment:
      WORKERS: "http://worker1:8001,http://worker2:8002,http://worker3:8003,http://worker4:8004"
      REPLICAS: "3"
      HEARTBEAT_TIMEOUT: "6"
      CHECK_INTERVAL: "2"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 5s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  worker1:
    build: .
    command: uvicorn worker:app --host 0.0.0.0 --port 8001
    environment:
      CONTROLLER: "http://controller:8000"
      ADDRESS: "http://worker1:8001"
      ID: "w1"
      WRITE_QUORUM: "2"
      DATA_DIR: "/app/data"
    ports:
      - "8001:8001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 5s
      timeout: 3s
      retries: 3
    restart: unless-stopped
    volumes:
      - worker1_data:/app/data

  worker2:
    build: .
    command: uvicorn worker:app --host 0.0.0.0 --port 8002
    environment:
      CONTROLLER: "http://controller:8000"
      ADDRESS: "http://worker2:8002"
      ID: "w2"
      WRITE_QUORUM: "2"
      DATA_DIR: "/app/data"
    ports:
      - "8002:8002"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 5s
      timeout: 3s
      retries: 3
    restart: unless-stopped
    volumes:
      - worker2_data:/app/data

  worker3:
    build: .
    command: uvicorn worker:app --host 0.0.0.0 --port 8003
    environment:
      CONTROLLER: "http://controller:8000"
      ADDRESS: "http://worker3:8003"
      ID: "w3"
      WRITE_QUORUM: "2"
      DATA_DIR: "/app/data"
    ports:
      - "8003:8003"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 5s
      timeout: 3s
      retries: 3
    restart: unless-stopped
    volumes:
      - worker3_data:/app/data

  worker4:
    build: .
    command: uvicorn worker:app --host 0.0.0.0 --port 8004
    environment:
      CONTROLLER: "http://controller:8000"
      ADDRESS: "http://worker4:8004"
      ID: "w4"
      WRITE_QUORUM: "2"
      DATA_DIR: "/app/data"
    ports:
      - "8004:8004"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/health"]
      interval: 5s
      timeout: 3s
      retries: 3
    restart: unless-stopped
    volumes:
      - worker4_data:/app/data

volumes:
  # define named volumes if you later add persistence per-worker
  worker1_data: {}
  worker2_data: {}
  worker3_data: {}
  worker4_data: {}
